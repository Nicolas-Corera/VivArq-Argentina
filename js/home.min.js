import{getAuth,onAuthStateChanged,signOut}from"./firebase-config.js";import{getFirestore,getDoc,doc,collection,query,where,getDocs,orderBy,limit}from"./firebase-config.js";import{countAllUnreadMessages}from"./unread-messages-tracker.js";const authButtons=document.getElementById("authButtons"),userMenu=document.getElementById("userMenu"),userAvatar=document.getElementById("userAvatar"),userName=document.getElementById("userName"),accountTypeProfile=document.getElementById("accountTypeProfile"),profileLink=document.getElementById("accountLink"),messagesLink=document.getElementById("messagesLink"),logoutBtn=document.getElementById("logoutBtn"),dropdownMenu=document.getElementById("dropdownMenu"),defaultProfileImageURL="https://placehold.co/600x400?text=Sin+Imágen",auth=getAuth(),db=getFirestore();function redirectToProfile(){const userId=localStorage.getItem("logguedInUserId"),userRole=localStorage.getItem("userRole");Date.now();if(console.log("Función redirectToProfile llamada."),console.log("ID de usuario:",userId),console.log("Rol del usuario:",userRole),!userId||!userRole)return console.error("Datos de usuario incompletos en localStorage"),void(window.location.href="login.html");"professional"===userRole?(console.log("Redirigiendo a profile-professional.html"),window.location.href=`profile-professional.html?id=${userId}`):(console.log("Redirigiendo a profile-contractor.html"),window.location.href=`profile-contractor.html?id=${userId}`)}userMenu&&userMenu.classList.add("hidden"),authButtons&&(authButtons.innerHTML='<div class="loading">Cargando...</div>'),window.redirectToProfile=redirectToProfile,onAuthStateChanged(auth,(async user=>{if(user){const logguedInUserId=user.uid;if(localStorage.setItem("logguedInUserId",logguedInUserId),logguedInUserId){const docRef=doc(db,"users",logguedInUserId),docSnap=await getDoc(docRef);if(docSnap.exists()){const userData=docSnap.data(),profilePictureURL=userData.profilePicture||defaultProfileImageURL,userInfo=userData.userInfo,accountType=userInfo?userInfo["5_Tipo de Cuenta"]:"contractor";if(localStorage.setItem("userRole",accountType),console.log("Tipo de cuenta detectado:",accountType),authButtons&&(authButtons.innerHTML="",authButtons.classList.add("hidden")),userMenu&&userMenu.classList.remove("hidden"),userAvatar&&(userAvatar.src=profilePictureURL,userAvatar.onerror=()=>{userAvatar.src=defaultProfileImageURL}),userName&&userInfo&&(userName.textContent=userInfo["2_Nombre y Apellido"]||"Usuario"),accountTypeProfile){const userId=localStorage.getItem("logguedInUserId"),userRole=localStorage.getItem("userRole");if(userId){const docRef=doc(db,"users",userId);getDoc(docRef).then((docSnap=>{if(docSnap.exists()){const userInfo=docSnap.data().userInfo;userInfo&&("professional"===userRole&&userInfo["7_Profesión"]?accountTypeProfile.textContent=userInfo["7_Profesión"]:accountTypeProfile.textContent="contractor"===userRole?"Cliente":"professional"===userInfo["5_Tipo de Cuenta"]?userInfo["7_Profesión"]||"Profesional":"Cliente")}})).catch((error=>{console.error("Error al obtener datos del usuario:",error),accountTypeProfile.textContent="professional"===userRole?"Profesional":"Cliente"}))}else accountTypeProfile.textContent="Usuario"}profileLink&&(profileLink.onclick=null,profileLink.addEventListener("click",(function(e){e.preventDefault(),redirectToProfile()})))}else console.log("No se encontraron los documentos del usuario."),authButtons&&(authButtons.innerHTML='\n            <a href="login.html" class="btn btn-login">Acceder</a>\n          ',authButtons.classList.remove("hidden")),userMenu&&userMenu.classList.add("hidden")}else console.log("ID del usuario no encontrado en localStorage"),authButtons&&(authButtons.innerHTML='\n          <a href="login.html" class="btn btn-login">Acceder</a>\n        ',authButtons.classList.remove("hidden")),userMenu&&userMenu.classList.add("hidden")}else authButtons&&(authButtons.innerHTML='\n        <a href="login.html" class="btn btn-login">Acceder</a>\n      ',authButtons.classList.remove("hidden")),userMenu&&userMenu.classList.add("hidden")})),logoutBtn&&logoutBtn.addEventListener("click",(e=>{e.preventDefault(),signOut(auth).then((()=>{localStorage.removeItem("userRole"),localStorage.removeItem("logguedInUserId"),window.location.reload()})).catch((error=>{console.error("Error al cerrar sesión:",error.message)}))}));const menuToggle=document.getElementById("menuToggle"),navbar=document.querySelector(".navbar"),navLinks=document.querySelector("nav ul");function closeUserDropdown(){dropdownMenu&&dropdownMenu.classList.contains("active")&&(dropdownMenu.classList.remove("active"),document.body.classList.remove("menu-active"),navbar.classList.remove("white-background"),userMenu.classList.remove("white-background"))}function closeNavMenu(){if(navLinks.classList.contains("active")){navLinks.classList.remove("active");const icon=menuToggle.querySelector("i");icon.classList.remove("fa-times"),icon.classList.add("fa-bars"),authButtons&&(authButtons.style.display=""),userMenu&&(userMenu.style.display="")}}function getProfileImageByRole(profession){const professionImages={Arquitecto:"/vivarq/images/ARQUITECTO.jpeg",Ingeniero:"/vivarq/images/ingeniero.jpeg",Constructor:"/vivarq/images/constructor.jpeg",Electricista:"/vivarq/images/electricista.jpeg",Plomero:"/vivarq/images/plomero.jpeg",Gasista:"/vivarq/images/gasista.jpeg",default:"/vivarq/images/predeterminado.jpeg"};return professionImages[profession]||professionImages.default}userAvatar&&userMenu&&dropdownMenu&&(userMenu.addEventListener("click",(e=>{e.stopPropagation(),closeNavMenu(),dropdownMenu.classList.toggle("active"),userMenu.classList.toggle("white-background"),dropdownMenu.classList.contains("active")?document.body.classList.add("menu-active"):(document.body.classList.remove("menu-active"),navbar.classList.remove("white-background"),userMenu.classList.remove("white-background"))})),document.addEventListener("click",(e=>{dropdownMenu&&dropdownMenu.classList.contains("active")&&!userMenu.contains(e.target)&&!dropdownMenu.contains(e.target)&&(dropdownMenu.classList.remove("active"),userMenu.classList.remove("white-background"),document.body.classList.remove("menu-active"),navbar.classList.remove("white-background"))})),dropdownMenu&&dropdownMenu.addEventListener("click",(e=>{e.stopPropagation()}))),menuToggle&&(menuToggle.addEventListener("click",(e=>{e.stopPropagation(),closeUserDropdown(),navLinks.classList.toggle("active"),navbar.classList.toggle("white-background");const icon=menuToggle.querySelector("i");navLinks.classList.contains("active")?(icon.classList.remove("fa-bars"),icon.classList.add("fa-times"),authButtons&&!authButtons.classList.contains("hidden")&&(authButtons.style.display="flex"),userMenu&&!userMenu.classList.contains("hidden")&&(userMenu.style.display="flex")):(icon.classList.remove("fa-times"),icon.classList.add("fa-bars"),authButtons&&(authButtons.style.display=""),userMenu&&(userMenu.style.display=""))})),document.addEventListener("click",(e=>{navLinks.classList.contains("active")&&!navbar.contains(e.target)&&(closeNavMenu(),navbar.classList.remove("white-background"))})),navLinks.addEventListener("click",(e=>{"A"===e.target.tagName?(closeNavMenu(),navbar.classList.remove("white-background")):(e.stopPropagation(),navbar.classList.remove("white-background"))})));const loadFeaturedProfessionals=async()=>{const featuredProfessionalsContainer=document.getElementById("featuredProfessionals");if(featuredProfessionalsContainer){featuredProfessionalsContainer.innerHTML='<div class="loading">Cargando profesionales...</div>';try{const usersRef=collection(db,"users"),q=query(usersRef,where("userInfo.5_Tipo de Cuenta","==","professional")),querySnapshot=await getDocs(q);if(featuredProfessionalsContainer.innerHTML="",querySnapshot.empty)return featuredProfessionalsContainer.innerHTML='\n       <div class="empty-results">\n        <div class="empty-results-icon-x">\n          <i class="fas fa-x"></i>\n        </div>\n          <h3>NO HAY PROFESIONALES REGISTRADOS EN ESTE MOMENTO.</h3>\n      </div>\n      ',void(featuredProfessionalsContainer.style.gridTemplateColumns="auto");querySnapshot.forEach((doc=>{const professionalData=doc.data(),userInfo=professionalData.userInfo,profession=userInfo["7_Profesión"]||"default";let profileImage=professionalData.profilePicture||userInfo.profileImageUrl||getProfileImageByRole(profession);const professionalCard=document.createElement("div");professionalCard.className="professional-card",professionalCard.innerHTML=`\n          <div class="professional-image">\n            <img src="${profileImage}" alt="${userInfo["2_Nombre y Apellido"]}" onerror="this.src='${getProfileImageByRole(profession)}'">\n          </div>\n          <div class="professional-info">\n            <h3>${userInfo["2_Nombre y Apellido"]}</h3>\n            <p class="profession">${userInfo["7_Profesión"]||"Profesional"}</p>\n            <p class="location"><i class="fas fa-map-marker-alt"></i> ${userInfo["6_Ubicación"]}</p>\n          </div>\n        `,professionalCard.addEventListener("click",(()=>{viewProfessionalProfile(doc.id)})),featuredProfessionalsContainer.appendChild(professionalCard)}))}catch(error){console.error("Error al cargar profesionales:",error),featuredProfessionalsContainer.innerHTML='\n        <div class="error-message">\n          <p>Error al cargar profesionales. Intente nuevamente más tarde.</p>\n        </div>\n      '}}};function viewProfessionalProfile(professionalId){if(!professionalId)return void console.error("ID de profesional no proporcionado");const viewingParam=professionalId===localStorage.getItem("logguedInUserId")?"own":"other";window.location.href=`profile-professional.html?user=${professionalId}&viewing=${viewingParam}`}const loadFeaturedProjects=async()=>{const featuredProjectsContainer=document.getElementById("featuredProjects");if(featuredProjectsContainer){featuredProjectsContainer.innerHTML='<div class="loading">Cargando proyectos...</div>';try{const projectsRef=collection(db,"projects"),q=query(projectsRef,where("status","==","published"),orderBy("createdAt","desc"),limit(3)),querySnapshot=await getDocs(q);if(featuredProjectsContainer.innerHTML="",querySnapshot.empty)return featuredProjectsContainer.innerHTML='\n       <div class="empty-results">\n        <div class="empty-results-icon-x">\n          <i class="fas fa-x"></i>\n        </div>\n        <h3>NO HAY PROYECTOS PUBLICADOS EN ESTE MOMENTO.</h3>\n      </div>\n        ',void(featuredProjectsContainer.style.gridTemplateColumns="auto");querySnapshot.forEach((doc=>{const projectData=doc.data();let projectImage="https://placehold.co/600x400?text=Sin+Imágen";projectData.images&&projectData.images.length>0&&projectData.images[0].secure_url&&(projectImage=projectData.images[0].secure_url);const projectCard=document.createElement("div");projectCard.className="project-card",projectCard.innerHTML=`\n          <div class="project-image">\n            <img src="${projectImage}" alt="${projectData.title}">\n          </div>\n          <div class="project-info">\n            <h3>${projectData.title}</h3>\n            <p class="project-type">${projectData.category||"Sin categoría"}</p>\n            <p class="location"><i class="fas fa-map-marker-alt"></i> ${projectData.location||"Sin ubicación"}</p>\n            <p class="budget"><i class="fas fa-dollar-sign"></i> ${projectData.budgetRange||projectData.budget||"Presupuesto no especificado"}</p>\n          <button class="view-project-btn" data-id="${doc.id}">\n            Ver Detalles\n          </button>\n          </div>\n        `,projectCard.addEventListener("click",(()=>{window.location.href=`project-detail.html?id=${doc.id}`})),featuredProjectsContainer.appendChild(projectCard)}))}catch(error){console.error("Error al cargar proyectos:",error),featuredProjectsContainer.innerHTML='\n        <div class="error-message">\n          <p>Error al cargar proyectos. Intente nuevamente más tarde.</p>\n        </div>\n      '}}},loadTestimonials=()=>{const testimonialsContainer=document.getElementById("testimonials");if(testimonialsContainer){[{name:"Laura Martínez",role:"Propietaria",text:"Encontré al arquitecto perfecto para mi proyecto de reforma. El proceso fue rápido y sencillo, ¡y el resultado excepcional!",image:"https://placehold.co/600x400?text=Sin+Imágen"},{name:"Roberto Sánchez",role:"Arquitecto",text:"Gracias a VivArq he podido conectar con clientes que realmente valoran mi trabajo y me han permitido crecer profesionalmente.",image:"https://placehold.co/600x400?text=Sin+Imágen"},{name:"Claudia Torres",role:"Constructora",text:"La plataforma me ha permitido expandir mi negocio y encontrar proyectos interesantes en diferentes localidades.",image:"https://placehold.co/600x400?text=Sin+Imágen"}].forEach((testimonial=>{const testimonialCard=document.createElement("div");testimonialCard.className="testimonial-card",testimonialCard.innerHTML=`\n        <div class="testimonial-content">\n          <p>${testimonial.text}</p>\n        </div>\n        <div class="testimonial-author">\n          <img src="${testimonial.image}" alt="${testimonial.name}">\n          <div>\n            <h4>${testimonial.name}</h4>\n            <p>${testimonial.role}</p>\n          </div>\n        </div>\n      `,testimonialsContainer.appendChild(testimonialCard)}))}};function setupSearchTabs(){console.log("Setting up search tabs");const tabButtons=document.querySelectorAll(".tab-btn"),searchForms=document.querySelectorAll(".search-form");tabButtons.forEach((button=>{button.addEventListener("click",(()=>{console.log(`Tab clicked: ${button.getAttribute("data-tab")}`),tabButtons.forEach((btn=>btn.classList.remove("active"))),button.classList.add("active"),searchForms.forEach((form=>form.classList.add("hidden")));const tabId=button.getAttribute("data-tab"),formToShow=document.getElementById(`${tabId}Search`);formToShow?formToShow.classList.remove("hidden"):console.warn(`Form not found for tab: ${tabId}`)}))}))}function resetProfessionalsFilter(){const professionFilter=document.getElementById("professionFilter");professionFilter&&(professionFilter.selectedIndex=0);const resultsContainer=document.getElementById("searchResults");resultsContainer&&(resultsContainer.innerHTML='\n      <div class="empty-results">\n        <div class="empty-results-icon">\n          <i class="fas fa-search"></i>\n        </div>\n        <h3>AQUÍ APARECERÁN LOS RESULTADOS DE LAS BÚSQUEDAS</h3>\n        <p>\n          Utiliza los filtros de arriba para encontrar profesionales o proyectos\n        </p>\n      </div>',resultsContainer.style.gridTemplateColumns="auto")}function resetProjectsFilter(){const projectTypeFilter=document.getElementById("projectTypeFilter");projectTypeFilter&&(projectTypeFilter.selectedIndex=0);const resultsContainer=document.getElementById("searchResults");resultsContainer&&(resultsContainer.innerHTML='\n      <div class="empty-results">\n        <div class="empty-results-icon">\n          <i class="fas fa-search"></i>\n        </div>\n        <h3>AQUÍ APARECERÁN LOS RESULTADOS DE LAS BÚSQUEDAS</h3>\n        <p>\n          Utiliza los filtros de arriba para encontrar profesionales o proyectos\n        </p>\n      </div>',resultsContainer.style.gridTemplateColumns="auto")}async function searchProfessionals(){const professionalSearchBtn=document.querySelector("#professionalsSearch .search-btn"),profession=document.getElementById("professionFilter").value,otherInput=document.getElementById("otherProfessionInput"),selectedProfessionText="Otro"===profession&&otherInput&&""!==otherInput.value.trim()?otherInput.value.trim():profession,usersRef=collection(db,"users"),standardProfessions=["Arquitecto","Ingeniero","Constructor","Electricista","Plomero","Gasista"];professionalSearchBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i>Buscando',professionalSearchBtn.disabled=!0;try{let q=query(usersRef,where("userInfo.5_Tipo de Cuenta","==","professional"));profession&&""!==profession&&(q=query(q,"Otro"===profession?where("userInfo.7_Profesión","not-in",standardProfessions):where("userInfo.7_Profesión","==",profession)));const querySnapshot=await getDocs(q),resultsContainer=document.getElementById("searchResults");resultsContainer.innerHTML="",professionalSearchBtn.innerHTML='<i class="fas fa-search"></i>Buscar',professionalSearchBtn.disabled=!1;querySnapshot.docs[0]?.data();if(querySnapshot.empty)return resultsContainer.innerHTML=`\n       <div class="empty-results">\n        <div class="empty-results-icon-x">\n          <i class="fas fa-x"></i>\n        </div>\n        <h3>NO SE ENCONTRARON PROFESIONALES QUE COINCIDAN CON LOS FILTROS.</h3>\n        <p style="color: black;">\n        <strong>"${selectedProfessionText}"</strong>\n        </p>\n      </div>\n      `,void(resultsContainer.style.gridTemplateColumns="auto");querySnapshot.forEach((doc=>{const professionalData=doc.data(),userInfo=professionalData.userInfo,profession=userInfo["7_Profesión"]||"default",profileImage=professionalData.profilePicture||userInfo.profileImageUrl||getProfileImageByRole(profession),resultCard=document.createElement("div");resultCard.className="professional-card",resultCard.innerHTML=`\n        <div class="professional-image">\n          <img src="${profileImage}" alt="${userInfo["2_Nombre y Apellido"]}"\n               onerror="this.src='${getProfileImageByRole(profession)}">\n        </div>\n        <div class="professional-info">\n          <h3>${userInfo["2_Nombre y Apellido"]}</h3>\n          <p class="profession">\n            ${userInfo["7_Profesión"]||"Otra Profesión"}\n          </p>\n          <p class="location">\n            <i class="fas fa-map-marker-alt"></i> ${userInfo["6_Ubicación"]}\n          </p>\n          <p class="experience">\n            <i class="fas fa-briefcase"></i>\n            ${userInfo["8_Años de Experiencia"]||"No especificado"} años de experiencia\n          </p>\n          <button class="view-profile-btn" data-id="${doc.id}">\n            Ver Perfil\n          </button>\n        </div>\n      `,resultCard.querySelector(".view-profile-btn").addEventListener("click",(()=>{viewProfessionalProfile(doc.id)})),resultsContainer.appendChild(resultCard),resultsContainer.style.gridTemplateColumns="repeat(auto-fill, minmax(250px, 1fr))"}))}catch(error){console.error("Error al buscar profesionales:",error);const resultsContainer=document.getElementById("searchResults");resultsContainer.innerHTML='\n      <div class="error-message">\n        <p>Error al realizar la búsqueda. Intente nuevamente.</p>\n      </div>\n    ',resultsContainer.style.gridTemplateColumns="auto"}}async function searchProjects(){const projectSearchBtn=document.querySelector("#projectsSearch .search-btn"),projectType=document.getElementById("projectTypeFilter").value.trim(),otherProjectInput=document.getElementById("otherProjectInput"),selectedProjectsText="Otro"===projectType&&otherProjectInput&&""!==otherProjectInput.value.trim()?otherProjectInput.value.trim():projectType||"todos los tipos",projectsRef=collection(db,"projects");let q=query(projectsRef,where("status","==","published"));const conditions=[];projectType&&""!==projectType&&conditions.push(where("category","==",projectType)),conditions.forEach((condition=>{q=query(q,condition)})),projectSearchBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i>Buscando',projectSearchBtn.disabled=!0;try{const querySnapshot=await getDocs(q),resultsContainer=document.getElementById("searchResults");if(resultsContainer.innerHTML="",projectSearchBtn.innerHTML='<i class="fas fa-search"></i>Buscar',projectSearchBtn.disabled=!1,querySnapshot.empty)return resultsContainer.innerHTML=`\n      <div class="empty-results">\n        <div class="empty-results-icon-x">\n          <i class="fas fa-x"></i>\n        </div>\n        <h3>NO SE ENCONTRARON PROYECTOS QUE COINCIDAN CON LOS FILTROS.</h3>\n        <p style="color: black;">\n        <strong>"${selectedProjectsText}"</strong>\n        </p>\n      </div>\n      `,void(resultsContainer.style.gridTemplateColumns="auto");querySnapshot.forEach((doc=>{const projectData=doc.data(),projectImage=projectData.images&&projectData.images.length>0&&projectData.images[0].secure_url?projectData.images[0].secure_url:"https://placehold.co/600x400?text=Sin+Imágen",resultCard=document.createElement("div");resultCard.className="project-card",resultCard.innerHTML=`\n        <div class="project-image">\n          <img src="${projectImage}" alt="${projectData.title}"\n               onerror="this.src='https://placehold.co/600x400?text=Sin+imagen'">\n        </div>\n        <div class="project-info">\n          <h3>${projectData.title}</h3>\n          <p class="project-type">${projectData.category||"Sin categoría"}</p>\n          <p class="location">\n            <i class="fas fa-map-marker-alt"></i> ${projectData.location||"Sin ubicación"}\n          </p>\n          <p class="budget">\n            <i class="fas fa-dollar-sign"></i> ${projectData.budgetRange||"Presupuesto no especificado"}\n          </p>\n          <button class="view-project-btn" data-id="${doc.id}">\n            Ver Detalles\n          </button>\n        </div>\n      `,resultCard.querySelector(".view-project-btn").addEventListener("click",(()=>{window.location.href=`project-detail.html?id=${doc.id}`})),resultsContainer.appendChild(resultCard),resultsContainer.style.gridTemplateColumns="repeat(auto-fill, minmax(250px, 1fr))"}))}catch(error){console.error("Error al buscar proyectos:",error);const resultsContainer=document.getElementById("searchResults");resultsContainer.innerHTML='\n      <div class="error-message">\n        <p>Error al realizar la búsqueda. Intente nuevamente.</p>\n      </div>\n    ',resultsContainer.style.gridTemplateColumns="auto"}}document.addEventListener("DOMContentLoaded",(()=>{loadFeaturedProfessionals(),loadFeaturedProjects(),loadTestimonials(),setupSearchTabs(),countAllUnreadMessages();const professionalSearchBtn=document.querySelector("#professionalsSearch .search-btn"),projectSearchBtn=document.querySelector("#projectsSearch .search-btn");professionalSearchBtn&&professionalSearchBtn.addEventListener("click",searchProfessionals),projectSearchBtn&&projectSearchBtn.addEventListener("click",searchProjects);const resetProfessionalsBtn=document.getElementById("resetProfessionalsFilter"),resetProjectsBtn=document.getElementById("resetProjectsFilter");resetProfessionalsBtn&&resetProfessionalsBtn.addEventListener("click",resetProfessionalsFilter),resetProjectsBtn&&resetProjectsBtn.addEventListener("click",resetProjectsFilter)})),document.addEventListener("DOMContentLoaded",(()=>{const professionalSearchBtn=document.querySelector("#professionalsSearch .search-btn"),projectSearchBtn=document.querySelector("#projectsSearch .search-btn");professionalSearchBtn&&professionalSearchBtn.addEventListener("click",searchProfessionals),projectSearchBtn&&projectSearchBtn.addEventListener("click",searchProjects)}));export{searchProfessionals,searchProjects,setupSearchTabs};function setupSearchButtonsControl(){const professionFilter=document.getElementById("professionFilter"),projectTypeFilter=document.getElementById("projectTypeFilter"),searchProfessionalsBtn=document.getElementById("searchProfessionals"),searchProjectsBtn=document.getElementById("searchProjects");function updateProfessionalsButtonState(){professionFilter&&searchProfessionalsBtn&&(searchProfessionalsBtn.disabled=""===professionFilter.value||0===professionFilter.selectedIndex,searchProfessionalsBtn.disabled?searchProfessionalsBtn.classList.add("btn-disabled"):searchProfessionalsBtn.classList.remove("btn-disabled"))}function updateProjectsButtonState(){projectTypeFilter&&searchProjectsBtn&&(searchProjectsBtn.disabled=""===projectTypeFilter.value||0===projectTypeFilter.selectedIndex,searchProjectsBtn.disabled?searchProjectsBtn.classList.add("btn-disabled"):searchProjectsBtn.classList.remove("btn-disabled"))}updateProfessionalsButtonState(),updateProjectsButtonState(),professionFilter&&professionFilter.addEventListener("change",updateProfessionalsButtonState),projectTypeFilter&&projectTypeFilter.addEventListener("change",updateProjectsButtonState);const resetProfessionalsBtn=document.getElementById("resetProfessionalsFilter"),resetProjectsBtn=document.getElementById("resetProjectsFilter");resetProfessionalsBtn&&resetProfessionalsBtn.addEventListener("click",(function(){setTimeout(updateProfessionalsButtonState,0)})),resetProjectsBtn&&resetProjectsBtn.addEventListener("click",(function(){setTimeout(updateProjectsButtonState,0)}))}document.getElementById("settingsLink").addEventListener("click",(function(event){const userId=localStorage.getItem("logguedInUserId");event.preventDefault(),window.location.href=`config.html?id=${userId}`})),document.getElementById("faqLink").addEventListener("click",(function(event){event.preventDefault(),window.location.href="faq.html"})),document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".homeBtn").forEach((btn=>{btn.addEventListener("click",(function(event){event.preventDefault(),window.location.href="index.html"}))}))})),document.addEventListener("DOMContentLoaded",(function(){if(window.location.href.includes("index.html")){const publishProjectBtn=document.getElementById("publishProyect"),viewProjectsBtn=document.getElementById("viewProyects"),accessChatBtn=document.getElementById("accessChat"),searchTitle=document.getElementById("searchTitle"),searchDescription=document.getElementById("searchDescription"),startNowBtn=document.getElementById("startNow"),step1Title=document.querySelector(".process-step:nth-child(1) h3"),step1Description=document.querySelector(".process-step:nth-child(1) p"),step1Icon=document.querySelector(".process-step:nth-child(1) .process-icon i"),step2Icon=(document.querySelector(".process-step:nth-child(2) h3"),document.querySelector(".process-step:nth-child(2) p"),document.querySelector(".process-step:nth-child(2) .process-icon i")),step3Title=document.querySelector(".process-step:nth-child(3) h3"),step3Description=document.querySelector(".process-step:nth-child(3) p"),step3Icon=document.querySelector(".process-step:nth-child(3) .process-icon i"),step4Title=document.querySelector(".process-step:nth-child(4) h3"),step4Description=document.querySelector(".process-step:nth-child(4) p"),step4Icon=document.querySelector(".process-step:nth-child(4) .process-icon i"),userRole=localStorage.getItem("userRole"),userId=localStorage.getItem("logguedInUserId");if(startNowBtn&&(startNowBtn.onclick="professional"===userRole?function(){window.location.href=`profile-professional.html?id=${userId}`}:"contractor"===userRole?function(){window.location.href=`profile-contractor.html?id=${userId}`}:function(){window.location.href="login.html"}),"professional"===userRole)step1Title.textContent="Registro profesional",step1Description.textContent="Crea tu perfil profesional destacando tus habilidades, experiencia y portfolio para atraer a potenciales clientes.",step1Icon.className="fas fa-briefcase",searchTitle&&(searchTitle.textContent="Buscar proyectos"),searchDescription&&(searchDescription.textContent="Busca entre todos los proyectos publicados por los usuarios y elige el que más se adapte a tus habilidades."),step2Icon.className="fas fa-project-diagram",step3Title.textContent="Comunicación directa con clientes",step3Description.textContent="Utiliza nuestro chat integrado para hablar directamente con los clientes, hacer preguntas y negociar presupuestos.",step3Icon.className="fas fa-comments",step4Title.textContent="Ejecución del proyecto",step4Description.textContent="Trabaja en el proyecto contratado, manteniendo comunicación constante y entregando resultados de calidad.",step4Icon.className="fas fa-tasks",publishProjectBtn&&(publishProjectBtn.style.display="none"),viewProjectsBtn&&(viewProjectsBtn.style.display="block"),accessChatBtn&&(accessChatBtn.style.display="none");else if("contractor"===userRole)step1Title.textContent="Registro como cliente",step1Description.textContent="Crea tu cuenta como cliente y define tu perfil para conectar con los mejores profesionales del sector.",step1Icon.className="fas fa-user-tie",searchTitle&&(searchTitle.textContent="Publicar proyecto"),searchDescription&&(searchDescription.textContent="Describe tu proyecto en detalle para recibir propuestas de los profesionales más cualificados."),step2Icon.className="fas fa-bullhorn",step3Title.textContent="Comunicación directa con profesionales",step3Description.textContent="Revisa las propuestas recibidas, comunícate con los profesionales y elige al profesional ideal para tu proyecto.",step3Icon.className="fas fa-comments",step4Title.textContent="Gestión y seguimiento",step4Description.textContent="Supervisa el avance del proyecto, proporciona feedback y confirma la finalización satisfactoria del trabajo.",step4Icon.className="fas fa-chart-line",publishProjectBtn&&(publishProjectBtn.style.display="block",publishProjectBtn.onclick=function(){window.location.href=`profile-contractor.html?id=${userId}`}),viewProjectsBtn&&(viewProjectsBtn.style.display="none"),accessChatBtn&&(accessChatBtn.style.display="block",accessChatBtn.onclick=function(){window.location.href=`chat.html?id=${userId}`});else{step1Title.textContent="Registro y perfil",step1Description.textContent="Crea tu cuenta como profesional o cliente y completa tu perfil con tus especialidades, experiencia y portfolio.",step1Icon.className="fas fa-user-plus",searchTitle&&(searchTitle.textContent="Búsqueda o publicación"),searchDescription&&(searchDescription.textContent="Busca profesionales cualificados o publica tu proyecto para recibir propuestas de los mejores especialistas."),step2Icon.className="fas fa-search",step3Title.textContent="Comunicación directa",step3Description.textContent="Utiliza nuestro chat integrado para hablar directamente con los profesionales, hacer preguntas y negociar presupuestos.",step3Icon.className="fas fa-comments",step4Title.textContent="Aún hay más...",step4Description.innerHTML='Explora todas las características que <strong style="color: black">VivArq</strong> tiene para vos. <br />Si tienes alguna duda o sugerencia no dudes en contactarnos:\n      <li\n         class="openModalBtnEmail"\n            style="cursor: pointer; list-style: none">\n                      <i\n                        class="fas fa-envelope"\n                        style="color: var(--primary-color)"\n                      ></i\n                      ><a class="mailContact"> contacto@vivarq.com.ar</a>\n                      <style>\n                        .mailContact {\n                          color: #333;\n                          text-decoration: none;\n                          font-weight: 600;\n                          transition: var(--transition-speed);\n                        }\n                        .mailContact:hover {\n                          color: black;\n                          margin-left: 5px;\n                        }\n                      </style>\n                    </li>\n      ',step4Icon.className="fas fa-plus";const modal=document.getElementById("emailModal"),openModalBtn=document.querySelectorAll(".openModalBtnEmail"),closeBtn=document.getElementsByClassName("close-btnEmail")[0];openModalBtn.forEach((function(btn){btn.onclick=function(){modal.style.display="block",document.body.style.overflow="hidden"}})),closeBtn.onclick=function(){document.querySelector(".modal-contentEmail").animate([{transform:"scale(1)",opacity:1},{transform:"scale(0.9)",opacity:0}],{duration:400,easing:"ease-out"}).onfinish=function(){modal.style.display="none",document.body.style.overflow="auto"}},window.onclick=function(event){if(event.target==modal){document.querySelector(".modal-contentEmail").animate([{transform:"scale(1)",opacity:1},{transform:"scale(0.9)",opacity:0}],{duration:400,easing:"ease-out"}).onfinish=function(){modal.style.display="none",document.body.style.overflow="auto"}}};const emailForm=document.getElementById("emailForm"),subjectSelect=document.getElementById("subject"),messageTextarea=document.getElementById("message"),mensajes={"Consulta General":"Hola, me gustaría hacer una consulta general sobre el funcionamiento de la plataforma VivArq.","Soporte Técnico":"Hola, estoy teniendo un inconveniente técnico con la plataforma y necesito ayuda. A continuación detallo el problema:",Sugerencias:"Hola, quería compartir una sugerencia para mejorar la plataforma VivArq:"};function animateValue(id,start,end,duration){const obj=document.getElementById(id);if(!obj)return;let startTimestamp=null;const step=timestamp=>{startTimestamp||(startTimestamp=timestamp);const progress=Math.min((timestamp-startTimestamp)/duration,1);let value=Math.floor(progress*(end-start)+start);obj.innerHTML="successRate"===id?value+"%":"professionalCount"===id||"projectCount"===id?value+"+":value,progress<1&&window.requestAnimationFrame(step)};window.requestAnimationFrame(step)}window.addEventListener("DOMContentLoaded",(()=>{messageTextarea.value=mensajes[subjectSelect.value]})),subjectSelect.addEventListener("change",(()=>{messageTextarea.value=mensajes[subjectSelect.value]})),emailForm.onsubmit=function(event){event.preventDefault();const subject=document.getElementById("subject").value,message=document.getElementById("message").value;window.location.href=`mailto:info@vivarq.com.ar?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;document.querySelector(".modal-contentEmail").animate([{transform:"scale(1)",opacity:1},{transform:"scale(0.9)",opacity:0}],{duration:400,easing:"ease-out"}).onfinish=function(){modal.style.display="none",document.body.style.overflow="auto"}};const statsSection=document.querySelector(".stats-section");if(statsSection){const handleScroll=()=>{(function(el){const rect=el.getBoundingClientRect();return rect.top>=0&&rect.left>=0&&rect.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&rect.right<=(window.innerWidth||document.documentElement.clientWidth)})(statsSection)&&(animateValue("professionalCount",0,10,2e3),animateValue("projectCount",0,15,2e3),animateValue("successRate",0,95,2e3),animateValue("provinces",0,2,2e3),window.removeEventListener("scroll",handleScroll))};window.addEventListener("scroll",handleScroll),handleScroll()}publishProjectBtn&&(publishProjectBtn.style.display="none"),viewProjectsBtn&&(viewProjectsBtn.style.display="none"),accessChatBtn&&(accessChatBtn.style.display="none")}}})),document.addEventListener("DOMContentLoaded",(function(){setupSearchButtonsControl()}));